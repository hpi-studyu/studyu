image: cirrusci/flutter:beta

stages:
  - check-format
  - generate
  - build
  - verify

check-format:
  stage: check-format
  script:
    - flutter format -l 120 -n . --set-exit-if-changed
  tags:
    - app
  only:
    - merge_requests

generate:
  stage: generate
  before_script:
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.hpi.de/nof1/nof1_models.git".insteadOf git@gitlab.hpi.de:nof1/nof1_models.git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -t rsa gitlab.hpi.de >> ~/.ssh/known_hosts
    - flutter pub get
  script:
    - flutter pub run build_runner build
  artifacts:
    paths:
      - lib/**/*.g.dart
  tags:
    - app
  only:
    - merge_requests

build:
  stage: build
  script:
    - flutter build aot
  tags:
    - app
    - android
  only:
    - merge_requests

test:
  stage: verify
  script:
    - flutter test
  tags:
    - app
    - android
  only:
    - merge_requests

analyze:
  stage: verify
  script:
    - flutter analyze
  tags:
    - app
    - android
  only:
    - merge_requests
